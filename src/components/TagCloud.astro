---
import { urlifyToken, getTagsWithPosts } from "@/js/util.js";
import type { CollectionEntry } from "astro:content";

interface Props {
  unsortedPosts: CollectionEntry<"posts">[];
}

const { unsortedPosts } = Astro.props;

function generateTagCloud() {
  const tagsMap = getTagsWithPosts(unsortedPosts);

  // Convert tagsMap to an array of [tag, tagPosts] pairs and sort by usage (most to least)
  const tagArray = Array.from(tagsMap.entries())
    .sort(([, postsA], [, postsB]) => postsB.length - postsA.length)
    .slice(0, 50);

  // Guard against empty tags
  if (tagArray.length === 0) {
    return [];
  }

  // Find min and max tag counts
  const counts = tagArray.map(([, tagPosts]) => tagPosts.length);
  const minCount = Math.min(...counts);
  const maxCount = Math.max(...counts);

  // Function to calculate font size between 8 and 22
  const calculateFontSize = (count: number) => {
    const minFontSize = 8;
    const maxFontSize = 22;

    if (maxCount === minCount) {
      return minFontSize; // If all tags have the same count, use the smallest font size
    }

    // Linear interpolation to map the count to a font size between 8 and 22
    return (
      minFontSize +
      ((count - minCount) / (maxCount - minCount)) * (maxFontSize - minFontSize)
    );
  };

  // Sort alphabetically after slicing, then return the tag cloud with font sizes
  return tagArray
    .sort(([tagA], [tagB]) => tagA.localeCompare(tagB)) // Sort alphabetically
    .map(([tag, tagPosts]) => ({
      tag,
      count: tagPosts.length,
      fontSize: calculateFontSize(tagPosts.length), // Calculate font size based on count
    }));
}

const tags = generateTagCloud();
---

<aside id="tag-cloud">
  <h2>Tags</h2>
  <div>
    {
      tags.map((tagItem) => (
        <a
          href={`/tag/${urlifyToken(tagItem.tag)}/`}
          title={`${tagItem.count} posts tagged with "${tagItem.tag}"`}
          rel="tag"
          style={`font-size: ${tagItem.fontSize}pt;`}
        >
          {tagItem.tag}
        </a>
      ))
    }
  </div>
</aside>
